# Rabbit AI æ›´æ–°æ—¥å¿—

## 2024-12-26 é‡å¤§æ›´æ–°

### ğŸ¯ èƒ½é‡ç³»ç»Ÿä¼˜åŒ–

#### 1. å–æ¶ˆèƒ½é‡æç°é—¨æ§›
- **ä¿®æ”¹å‰**ï¼šæç°éœ€è¦æœ€ä½ 30 èƒ½é‡é—¨æ§›
- **ä¿®æ”¹å**ï¼šå–æ¶ˆæ‰€æœ‰èƒ½é‡é—¨æ§›ï¼Œåªéœ€æ»¡è¶³ 1 USDT = 10 èƒ½é‡çš„å…³ç³»
- **å½±å“æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/services/withdraw.ts` - ç§»é™¤ `minEnergyToWithdraw` æ£€æŸ¥
  - `rabbit-ai-backend/src/services/user.ts` - ç§»é™¤ `minEnergyToWithdraw` å­—æ®µ
  - `rabbit-ai-frontendxin/views/AssetView.tsx` - ç§»é™¤æ‰€æœ‰é—¨æ§›æ£€æŸ¥é€»è¾‘
  - `rabbit-ai-frontendxin/constants.ts` - ç§»é™¤ `ENERGY_WITHDRAW_THRESHOLD` å¸¸é‡å¼•ç”¨

#### 2. èƒ½é‡å¥–åŠ±è§„åˆ™è°ƒæ•´
- **ä¿®æ”¹å‰**ï¼šé‚€è¯·å¥½å‹æˆåŠŸè·å¾— 5 ç‚¹èƒ½é‡
- **ä¿®æ”¹å**ï¼š
  - é‚€è¯·å¥–åŠ±ï¼š2 ç‚¹èƒ½é‡ï¼ˆä»…ç¬¬ä¸€æ¬¡é‚€è¯·æ—¶ï¼‰
  - ç®¡é“æ”¶ç›Šï¼š1 ç‚¹èƒ½é‡ï¼ˆæ¯æ¬¡ä¸‹çº§é¢†å–ç©ºæŠ•æ—¶ï¼‰
  - ç¬¬ä¸€æ¬¡é‚€è¯·æ€»è®¡ï¼š2 + 1 = 3 ç‚¹
  - ä¹‹åæ¯æ¬¡ä¸‹çº§é¢†å–ï¼š1 ç‚¹
- **å½±å“æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/indexer/indexer.ts` - ä¿®æ”¹ `insertClaim` å‡½æ•°
  - `rabbit-ai-frontendxin/views/MiningView.tsx` - æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
  - `rabbit-ai-frontendxin/views/ProfileView.tsx` - æ›´æ–°æ´»åŠ¨è®°å½•æ˜¾ç¤º
  - `rabbit-ai-frontendxin/translations.ts` - æ›´æ–°å¤šè¯­è¨€æ–‡æœ¬

### ğŸ› é‡å¤§ Bug ä¿®å¤

#### 1. ä¿®å¤èƒ½é‡å¥–åŠ±é‡å¤é—®é¢˜
- **é—®é¢˜**ï¼šé¦–æ¬¡é‚€è¯·æ—¶ï¼Œ`Claimed` å’Œ `CooldownReset` äº‹ä»¶åŒæ—¶è§¦å‘ï¼Œå¯¼è‡´é‡å¤å¥–åŠ±
- **ä¿®å¤**ï¼šåˆ é™¤ `handleCooldownReset` ä¸­çš„èƒ½é‡å¥–åŠ±é€»è¾‘ï¼Œç»Ÿä¸€åœ¨ `insertClaim` ä¸­å¤„ç†
- **å½±å“æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/indexer/indexer.ts` - `handleCooldownReset` å‡½æ•°

#### 2. ä¼˜åŒ– referrer è·å–é€»è¾‘
- **é—®é¢˜**ï¼šåªé€šè¿‡è§£æäº¤æ˜“æ•°æ®è·å– referrerï¼Œè§£æå¤±è´¥ä¼šå¯¼è‡´ä¸¢å¤±
- **ä¿®å¤**ï¼šä¼˜å…ˆä»æ•°æ®åº“ `users.referrer_address` è·å–ï¼Œå¦‚æœæ•°æ®åº“æ²¡æœ‰å†ç”¨ `decodeReferrerFromTx`
- **å½±å“æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/indexer/indexer.ts` - `runOnce` å‡½æ•°ä¸­çš„ `Claimed` äº‹ä»¶å¤„ç†

#### 3. ä¿®å¤æ´»åŠ¨è®°å½•èƒ½é‡æ˜¾ç¤º
- **é—®é¢˜**ï¼šæ´»åŠ¨è®°å½•åªæ˜¾ç¤ºç¬¬ä¸€æ¬¡é‚€è¯·çš„èƒ½é‡ï¼Œä¸æ˜¾ç¤ºåç»­ä¸‹çº§é¢†å–çš„èƒ½é‡å¥–åŠ±
- **ä¿®å¤**ï¼š
  - åç«¯ `getReferralHistory` è¿”å›æ‰€æœ‰ claims è®°å½•ï¼ˆä¸åªæ˜¯ç¬¬ä¸€æ¬¡ï¼‰
  - åŠ¨æ€è®¡ç®—èƒ½é‡å¥–åŠ±ï¼ˆç¬¬ä¸€æ¬¡ 3 ç‚¹ï¼Œä¹‹å 1 ç‚¹ï¼‰
  - å‰ç«¯æ­£ç¡®æ˜¾ç¤ºæ¯æ¬¡ä¸‹çº§é¢†å–çš„èƒ½é‡å¥–åŠ±
- **å½±å“æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/services/user.ts` - `getReferralHistory` å‡½æ•°
  - `rabbit-ai-frontendxin/views/ProfileView.tsx` - æ´»åŠ¨è®°å½•æ˜¾ç¤ºé€»è¾‘

### ğŸ“ ä»£ç æ¸…ç†

#### ç§»é™¤æœªä½¿ç”¨çš„å¸¸é‡
- ç§»é™¤ `ENERGY_WITHDRAW_THRESHOLD` å¸¸é‡å¼•ç”¨
- æ¸…ç†æ‰€æœ‰ç›¸å…³çš„ç¡¬ç¼–ç æ£€æŸ¥

#### æ›´æ–°æ–‡æ¡£
- æ›´æ–°å‰ç«¯æ˜¾ç¤ºæ–‡æœ¬ï¼Œåæ˜ æ–°çš„èƒ½é‡å¥–åŠ±è§„åˆ™
- æ›´æ–°å¤šè¯­è¨€ç¿»è¯‘æ–‡ä»¶

---

## æŠ€æœ¯ç»†èŠ‚

### èƒ½é‡å¥–åŠ±è®¡ç®—é€»è¾‘

```typescript
// åœ¨ insertClaim å‡½æ•°ä¸­
let energyReward = 0;

// 1. é‚€è¯·å¥–åŠ±ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é¢†å–ï¼Œå¥–åŠ± +2 èƒ½é‡
if (isFirstClaim) {
  newInviteCount += 1;
  energyReward += 2; // é‚€è¯·å¥–åŠ±
}

// 2. ç®¡é“æ”¶ç›Šï¼šæ¯æ¬¡ä¸‹çº§é¢†å–ç©ºæŠ•ï¼Œä¸Šçº§è·å¾— +1 èƒ½é‡
energyReward += 1; // ç®¡é“æ”¶ç›Š
```

### æç°èƒ½é‡è®¡ç®—

```typescript
// åœ¨ applyWithdraw å‡½æ•°ä¸­
const requiredEnergy = amount * 10; // 1 USDT = 10 èƒ½é‡ï¼Œæ— æœ€ä½é—¨æ§›
if (energyAvailable < requiredEnergy) {
  throw new ApiError('ENERGY_NOT_ENOUGH', ...);
}
```

### æ´»åŠ¨è®°å½•æ•°æ®ç»“æ„

```typescript
// getReferralHistory è¿”å›æ ¼å¼
{
  address: string,        // è¢«é‚€è¯·äººåœ°å€
  energy: number,         // èƒ½é‡å¥–åŠ±ï¼ˆç¬¬ä¸€æ¬¡3ç‚¹ï¼Œä¹‹å1ç‚¹ï¼‰
  rewardAmount: string,   // RAT å¥–åŠ±é‡‘é¢
  createdAt: string,      // åˆ›å»ºæ—¶é—´
  txHash: string,         // äº¤æ˜“å“ˆå¸Œ
  isFirstClaim: boolean   // æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡é¢†å–
}
```

---

## æ•°æ®åº“å˜æ›´

### æ— æ•°æ®åº“ç»“æ„å˜æ›´
æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨ç°æœ‰è¡¨ç»“æ„åŸºç¡€ä¸Šè¿›è¡Œï¼Œæ— éœ€è¿ç§»ã€‚

### æ•°æ®å½±å“
- `users.energy_total` - èƒ½é‡æ€»æ•°ä¼šæ ¹æ®æ–°è§„åˆ™æ›´æ–°
- `claims` è¡¨ - è®°å½•æ‰€æœ‰ç©ºæŠ•é¢†å–ï¼Œç”¨äºè®¡ç®—èƒ½é‡å¥–åŠ±
- `referral_rewards` è¡¨ - è®°å½• RAT å¥–åŠ±ï¼ˆä¸å˜ï¼‰

---

## å‰ç«¯å˜æ›´

### UI æ›´æ–°
1. **æç° Modal**ï¼š
   - ç§»é™¤èƒ½é‡é˜ˆå€¼æ˜¾ç¤ºå¡ç‰‡
   - ä» 3 åˆ—æ”¹ä¸º 2 åˆ—ï¼ˆå½“å‰èƒ½é‡ + æ‰€éœ€èƒ½é‡ï¼‰
   - ç§»é™¤èƒ½é‡ä¸è¶³æ—¶çš„é—¨æ§›æç¤º

2. **æ´»åŠ¨è®°å½•**ï¼š
   - æ˜¾ç¤ºæ‰€æœ‰ä¸‹çº§é¢†å–è®°å½•ï¼ˆä¸åªæ˜¯ç¬¬ä¸€æ¬¡ï¼‰
   - æ­£ç¡®æ˜¾ç¤ºæ¯æ¬¡çš„èƒ½é‡å¥–åŠ±å€¼
   - åŒºåˆ†é¦–æ¬¡é¢†å–å’Œåç»­é¢†å–çš„æ˜¾ç¤º

3. **æ¨èå¥–åŠ±æ˜¾ç¤º**ï¼š
   - æ›´æ–°ä¸º "+2" èƒ½é‡
   - æ·»åŠ ç®¡é“æ”¶ç›Šè¯´æ˜

---

## å‘åå…¼å®¹æ€§

### API å…¼å®¹æ€§
- âœ… `getUserInfo` ç§»é™¤ `minEnergyToWithdraw` å­—æ®µï¼ˆå‰ç«¯æœªä½¿ç”¨ï¼Œä¸å½±å“ï¼‰
- âœ… `getReferralHistory` è¿”å›æ ¼å¼æ‰©å±•ï¼ˆæ·»åŠ  `isFirstClaim` å­—æ®µï¼Œå‘åå…¼å®¹ï¼‰

### æ•°æ®å…¼å®¹æ€§
- âœ… ç°æœ‰æ•°æ®ä¸å—å½±å“
- âœ… æ–°è§„åˆ™è‡ªåŠ¨åº”ç”¨åˆ°æ–°äº¤æ˜“

---

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. **æç°æµ‹è¯•**ï¼š
   - æµ‹è¯•æç° 0.1 USDTï¼ˆéœ€è¦ 1 èƒ½é‡ï¼‰
   - æµ‹è¯•æç° 1 USDTï¼ˆéœ€è¦ 10 èƒ½é‡ï¼‰
   - éªŒè¯æ— æœ€ä½é—¨æ§›é™åˆ¶

2. **èƒ½é‡å¥–åŠ±æµ‹è¯•**ï¼š
   - æµ‹è¯•é¦–æ¬¡é‚€è¯·çš„èƒ½é‡å¥–åŠ±ï¼ˆåº”è¯¥æ˜¯ 3 ç‚¹ï¼‰
   - æµ‹è¯•åç»­ä¸‹çº§é¢†å–çš„èƒ½é‡å¥–åŠ±ï¼ˆåº”è¯¥æ˜¯ 1 ç‚¹ï¼‰
   - éªŒè¯æ´»åŠ¨è®°å½•æ­£ç¡®æ˜¾ç¤º

3. **é‡å¤å¥–åŠ±æµ‹è¯•**ï¼š
   - éªŒè¯é¦–æ¬¡é‚€è¯·ä¸ä¼šé‡å¤å¥–åŠ±
   - éªŒè¯ `CooldownReset` äº‹ä»¶ä¸å†è§¦å‘èƒ½é‡å¥–åŠ±

---

## ç›¸å…³æäº¤

- `fix: å–æ¶ˆæç°çš„ 30 èƒ½é‡é—¨æ§›é™åˆ¶`
- `feat: ä¿®æ”¹èƒ½é‡å¥–åŠ±é€»è¾‘ - é‚€è¯·å¥–åŠ±ä» 5 ç‚¹æ”¹ä¸º 2 ç‚¹ï¼Œæ–°å¢ç®¡é“æ”¶ç›Šæ¯æ¬¡ +1 ç‚¹`
- `fix: ä¿®å¤èƒ½é‡å¥–åŠ±é‡å¤å’Œ referrer è·å–é—®é¢˜`
- `feat: ä¿®æ”¹ getReferralHistory è¿”å›æ‰€æœ‰ä¸‹çº§é¢†å–è®°å½•å¹¶è®¡ç®—èƒ½é‡å¥–åŠ±`
- `fix: ç§»é™¤ minEnergyToWithdraw å­—æ®µï¼Œå·²å–æ¶ˆèƒ½é‡é—¨æ§›`

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. ç›‘æ§èƒ½é‡å¥–åŠ±æ˜¯å¦æ­£ç¡®è®¡ç®—
2. ç›‘æ§æç°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

