# 能量配置缓存问题分析报告

**日期**: 2026-01-06  
**问题**: 后台修改能量配置后，前端显示未更新（仍显示旧值 10，而不是新值 15）

---

## 🔍 问题分析

### 发现的缓存问题

#### 1. **localStorage 缓存时间过长** ❌
- **问题**: 缓存时间设置为 5 分钟
- **影响**: 用户在 5 分钟内访问，会看到旧配置
- **位置**: `api.ts` → `getPublicEnergyConfig()`

#### 2. **API 请求没有缓存控制** ❌
- **问题**: API 调用没有添加时间戳参数和缓存控制头
- **影响**: 
  - 浏览器可能缓存 HTTP 响应
  - Cloudflare CDN 可能缓存 API 响应
- **位置**: `api.ts` → `getPublicEnergyConfig()` 和 `getVipTiers()`

#### 3. **代码逻辑正确，但缓存导致延迟** ✅
- **代码检查**: 
  - `AssetView.tsx` 第 1237 行：使用 `energyConfig.withdraw_energy_ratio` ✅
  - `ProfileView.tsx` 第 920、923 行：使用 `energyConfig.withdraw_energy_ratio` ✅
- **结论**: 代码逻辑正确，问题出在缓存机制

---

## 🛠️ 修复方案

### 修复 1: 减少 localStorage 缓存时间
```typescript
// 修复前
const CACHE_DURATION = 5 * 60 * 1000; // 5分钟

// 修复后
const CACHE_DURATION = 1 * 60 * 1000; // 1分钟（更快响应配置变更）
```

### 修复 2: 添加时间戳参数绕过缓存
```typescript
// 修复前
const response = await apiFetch('/public/energy-config');

// 修复后
const timestamp = Date.now();
const response = await api.get(`/public/energy-config?_t=${timestamp}`, {
  headers: {
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0'
  }
});
```

### 修复 3: 修复 `getVipTiers` 函数
- **问题**: 使用了不存在的 `apiFetch` 函数
- **修复**: 改为使用 `api.get`，并添加相同的缓存控制

---

## 📊 缓存层级分析

### 缓存层级（从内到外）

1. **localStorage 缓存** ✅ 已修复
   - 位置: 浏览器本地存储
   - 时间: 1 分钟（修复后）
   - 清除: `localStorage.removeItem('PUBLIC_ENERGY_CONFIG_CACHE')`

2. **浏览器 HTTP 缓存** ✅ 已修复
   - 位置: 浏览器缓存
   - 修复: 添加 `Cache-Control: no-cache` 头
   - 修复: 添加时间戳参数 `?_t=${timestamp}`

3. **Cloudflare CDN 缓存** ⚠️ 需要手动处理
   - 位置: Cloudflare 边缘节点
   - 影响: 如果使用了 Cloudflare，可能需要清除 CDN 缓存
   - 解决方案:
     - 在 Cloudflare Dashboard 清除缓存
     - 或者等待缓存自动过期（通常 2-4 小时）
     - 或者使用开发模式（Bypass Cache）

4. **后端 API 缓存** ✅ 已处理
   - 位置: 后端服务（60 秒缓存）
   - 状态: 后端已有缓存机制，但会定期刷新

---

## 🧪 测试步骤

### 步骤 1: 清除浏览器缓存
```javascript
// 在浏览器控制台运行
localStorage.removeItem('PUBLIC_ENERGY_CONFIG_CACHE');
localStorage.removeItem('VIP_TIERS_CACHE');
localStorage.removeItem('vip_tiers_cache');
location.reload(true);
```

### 步骤 2: 强制刷新页面
- Windows: `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`

### 步骤 3: 使用诊断脚本
```javascript
// 在浏览器控制台运行诊断脚本
// 文件位置: rabbit-ai-frontendxin/能量配置缓存诊断脚本.js
```

### 步骤 4: 验证显示
1. 打开提现弹窗
2. 检查"能量消耗"显示是否为最新值（15）
3. 打开能量说明弹窗
4. 检查"1:15 比例"和"每提现 1 USDT 需消耗 15 单位能量"是否正确

---

## 🔧 Cloudflare 缓存处理（如果使用）

### 方案 A: 清除 Cloudflare 缓存
1. 登录 Cloudflare Dashboard
2. 选择你的域名
3. 进入 "Caching" → "Purge Cache"
4. 选择 "Purge Everything" 或 "Custom Purge"（仅清除 `/api/public/energy-config`）

### 方案 B: 配置缓存规则
在 Cloudflare 中为 `/api/public/energy-config` 设置缓存规则：
- **Cache Level**: Bypass（绕过缓存）
- 或者设置 **TTL**: 1 分钟

### 方案 C: 使用开发模式
在 Cloudflare Dashboard 中启用 "Development Mode"（开发模式），这会绕过所有缓存。

---

## 📝 修复文件清单

### 已修复的文件

1. **`api.ts`**
   - ✅ `getPublicEnergyConfig()`: 减少缓存时间到 1 分钟，添加时间戳和缓存控制头
   - ✅ `getVipTiers()`: 修复 `apiFetch` 错误，添加缓存控制和时间戳

2. **`能量配置缓存诊断脚本.js`** (新增)
   - 诊断工具：检查缓存状态、对比 API 值、提供修复方案

---

## ✅ 预期效果

### 修复前
- 缓存时间: 5 分钟
- API 请求: 可能被浏览器/CDN 缓存
- 配置更新延迟: 最长 5 分钟 + CDN 缓存时间

### 修复后
- 缓存时间: 1 分钟
- API 请求: 强制绕过缓存（时间戳 + 缓存控制头）
- 配置更新延迟: 最长 1 分钟

---

## 🚀 部署状态

- ✅ **代码已提交**: `f941400`
- ✅ **已推送到 GitHub**: `rabbit-ai-frontendxin`
- ⏳ **Vercel 自动部署中**: 预计 2-3 分钟

---

## 📋 验证清单

部署完成后，请验证：

- [ ] 清除浏览器缓存（`Ctrl + Shift + R`）
- [ ] 打开提现弹窗，检查"能量消耗"显示
- [ ] 打开能量说明弹窗，检查"1:15 比例"显示
- [ ] 等待 1 分钟后，再次检查（验证缓存刷新）
- [ ] 如果使用 Cloudflare，检查是否需要清除 CDN 缓存

---

## 💡 建议

1. **定期清除缓存**: 如果配置频繁变更，建议在后台修改配置后，提示用户清除缓存
2. **监控缓存命中率**: 可以添加日志监控缓存使用情况
3. **考虑 WebSocket**: 对于需要实时更新的配置，可以考虑使用 WebSocket 推送

---

## 📞 如果问题仍然存在

如果修复后问题仍然存在，请：

1. 运行诊断脚本（`能量配置缓存诊断脚本.js`）
2. 检查浏览器控制台的网络请求，确认 API 返回的值
3. 检查 Cloudflare 缓存状态（如果使用）
4. 提供诊断脚本的输出结果

---

**报告生成时间**: 2026-01-06  
**修复版本**: `f941400`

