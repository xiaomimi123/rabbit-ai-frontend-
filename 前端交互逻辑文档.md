# Rabbit AI 前端交互逻辑文档

## 目录
1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [应用架构](#应用架构)
4. [页面结构](#页面结构)
5. [核心功能模块](#核心功能模块)
6. [交互流程](#交互流程)
7. [API 接口](#api-接口)
8. [状态管理](#状态管理)
9. [钱包集成](#钱包集成)
10. [数据流](#数据流)
11. [错误处理](#错误处理)
12. [安全考虑](#安全考虑)
13. [性能优化](#性能优化)
14. [开发注意事项](#开发注意事项)

---

## 项目概述

Rabbit AI 是一个基于 BNB Smart Chain 的去中心化应用（DApp），采用"持币生息"模式，用户只需在钱包中持有 RAT 代币即可获得 USDT 收益。前端使用 React + TypeScript + Vite 构建，支持多语言，提供完整的 Web3 交互体验。

### 核心特性
- **持币生息**：用户持有 RAT 代币，后端自动计算 USDT 收益
- **每日空投**：用户可每日领取随机 RAT 空投奖励
- **推荐系统**：邀请好友获得能量和代币奖励
- **能量系统**：提现收益需要消耗能量值
- **VIP 等级**：根据持币量自动升级，享受不同日利率

---

## 技术栈

- **框架**：React 18 + TypeScript
- **构建工具**：Vite
- **样式**：Tailwind CSS
- **Web3**：ethers.js
- **钱包连接**：WalletConnect + MetaMask/OKX/Binance/Trust Wallet
- **HTTP 客户端**：Axios
- **国际化**：自定义 i18n 系统（支持中文、英文、日文、韩文、法文、俄文）

---

## 应用架构

### 文件结构
```
rabbit-ai-frontendxin/
├── App.tsx                 # 主应用组件，路由和全局状态
├── api.ts                  # API 接口封装
├── constants.ts            # 常量配置（合约地址、VIP 等级等）
├── types.ts                # TypeScript 类型定义
├── translations.ts        # 多语言翻译
├── index.tsx               # 应用入口
├── index.css               # 全局样式
├── contexts/
│   └── LanguageContext.tsx # 语言上下文
├── services/
│   └── web3Service.ts      # Web3 服务（钱包连接、合约交互）
├── views/
│   ├── MiningView.tsx      # 挖矿页面（空投领取）
│   ├── AssetView.tsx       # 资产页面（持币生息、提现）
│   ├── ProfileView.tsx     # 个人中心（历史记录、团队信息）
│   └── NotificationsView.tsx # 通知中心
└── components/
    └── ui/                 # UI 组件
```

### 组件层次
```
App (主应用)
├── Header (顶部导航栏)
│   ├── 语言切换菜单
│   ├── 通知按钮
│   └── 菜单按钮
├── Ticker (公告栏)
└── Main Content (主要内容区)
    ├── MiningView (挖矿页)
    ├── AssetView (资产页)
    ├── ProfileView (个人中心)
    └── NotificationsView (通知中心)
```

---

## 页面结构

### 1. 挖矿页面 (MiningView)

**功能**：每日空投领取和推荐系统

**主要组件**：
- **空投领取卡片**
  - 冷却时间倒计时显示（4小时）
  - 领取按钮（自动连接钱包）
  - 区块链同步状态提示
  - Gas 费用估算（0.0001 BNB）
- **推荐链接卡片**
  - **始终显示推荐链接**：
    - 如果钱包已连接：显示用户自己的推荐链接（`当前域名?ref=用户地址`）
    - 如果钱包未连接但 URL 有 `ref` 参数：显示推荐人的链接
    - 否则：显示当前页面链接
  - 一键复制功能（始终可用）
  - 推荐奖励说明（+5 能量 + 10% RAT）
- **奖励弹窗**
  - 动画效果（缩放、滑动、光效）
  - 显示获得的 RAT 数量
  - 显示获得的能量值

**交互流程**：
1. 用户点击"领取RAT空投奖励"按钮
2. 如果未连接钱包，自动弹出钱包连接界面（优先显示币安/OKX/Trust/SafePal/Uniswap）
3. 连接成功后，获取钱包地址并更新状态
4. 检查冷却时间（4小时）
5. **自动检查网络**：如果不是 BNB Smart Chain，自动调用 `switchNetwork()` 并等待切换完成
6. 检查 BNB 余额：
   - 费用：0.000444 BNB（合约要求）
   - **Gas 费用估算**：
     - **开发实现**：使用 `contract.estimateGas.claim()` 动态获取 Gas 估算值
     - **缓冲系数**：将估算值乘以 1.2 作为实际 Gas limit（防止 Out of Gas）
     - **UI 显示**：可以显示 "< 0.0005 BNB" 作为用户友好的提示
     - **实际发送**：使用动态估算的 Gas，确保交易成功
     - ⚠️ **风险提示**：不要写死 0.0001 BNB，因为合约逻辑复杂时可能导致 Out of Gas 失败
   - 总计需要：费用 + Gas
   - 如果不足，显示详细提示（当前余额 vs 需要余额）
7. 调用智能合约 `claim` 方法
8. 等待交易确认
9. 解析 `Claimed` 事件获取奖励金额
10. 显示奖励弹窗（显示获得的 RAT 和能量）
11. 同步到后端（自动重试机制，最多 5 次）
12. 触发能量刷新事件
13. **错误处理**：如果连接失败且错误码为 4001 或包含 "disconnect"/"reconnect"，显示自定义断开连接提示弹窗

**关键逻辑**：
- **默认页面**：应用启动时默认显示挖矿页面（`activeTab: 'mining'`）
- 冷却时间：从合约读取 `lastClaimTime`，计算剩余时间（4小时）
- **Referrer 持久化**：
  - 应用初始化时（`useEffect`），如果检测到 URL 有 `ref` 参数，立即存入 `localStorage`（键名：`rabbit_referrer`）
  - 在调用 `claim` 合约时，优先从 `localStorage` 读取推荐人地址
  - 如果 `localStorage` 中没有，再从 URL 参数获取
  - 如果都没有，使用 `0x0000000000000000000000000000000000000000`
  - ⚠️ **重要性**：这样即使用户刷新页面或通过多级路由跳转，推荐关系也不会丢失
- 后端同步：自动重试 5 次，每次间隔 2 秒，失败则加入本地队列
- 能量刷新：触发 `refreshEnergy` 事件
- **Gas 费用动态估算**：使用 `contract.estimateGas.claim()` 动态获取，乘以 1.2 缓冲系数
- **网络自动切换**：连接钱包后自动检查并切换到 BNB Smart Chain
- **断开连接提示**：连接失败时显示自定义弹窗，提示用户断开 DApp 后重新连接

---

### 2. 资产页面 (AssetView)

**功能**：持币生息展示、收益提现、VIP 等级

**主要组件**：
- **资产概览卡片**
  - 预估余额（RAT 余额 × 0.01 USDT）
  - 链上实时 RAT 余额
  - 持币生息状态
- **流动性收益池卡片**
  - 可提现 USDT 余额
  - 预计每日收益
  - 持币天数
  - 提现按钮（能量检查）
  - 历史记录按钮
- **VIP 等级卡片**
  - 当前等级显示
  - 等级进度条
  - 点击查看所有等级详情
- **提现 Modal**
  - 输入提现金额
  - 能量消耗计算（1 USDT = 10 能量）
  - 剩余能量显示
  - 能量水位线检查（最低 30 能量）

**交互流程**：

**资产加载**：
1. **优先从链上获取 RAT 余额**：使用 `ethers.js` 直接调用 RAT 代币合约的 `balanceOf` 方法
2. 如果链上读取失败，**降级到后端 API**：调用 `fetchRatBalance` API
3. 从后端获取收益信息（`fetchEarnings`）
4. **精度处理**：
   - RAT 代币：使用 `ethers.formatUnits(balanceWei, 18)` 转换（18 位精度）
   - USDT：检查合约精度（BSC 上通常是 18 位，跨链可能是 6 位）
   - 计算：余额 × 0.01 时，避免直接用 JS number 类型（会有精度丢失）
   - 建议：中间计算保持 BigInt 或使用专门的库，只在最后渲染 UI 时转为 number
5. 每 30 秒自动刷新 RAT 余额和收益信息
6. **BNB 余额自动更新**：每 10 秒从链上获取 BNB 余额并更新到全局状态
7. **加载状态处理**：
   - 区分 `0` 和 `null/undefined`
   - 数据加载中或请求失败时，显示骨架屏（Skeleton）或转圈动画，或显示 "--"
   - 只有当明确知道用户余额确实为 0 时，才显示 0
   - ⚠️ **体验问题**：如果 API 挂了，显示 0 会引发用户恐慌，应该显示加载状态

**提现流程**：
1. 用户点击"提现"按钮（**始终可点击，显示为黄色激活状态**）
2. 弹出提现 Modal，显示能量信息卡片：
   - 当前能量值（绿色/红色显示）
   - 能量阈值（30）
   - 所需能量（根据输入金额实时计算）
3. **能量不足时的交互限制**：
   - 输入框禁用（`disabled`，显示红色边框）
   - MAX 按钮禁用
   - 提交按钮禁用
   - 显示能量不足提示信息
4. 如果能量充足（≥30），用户可以：
   - 输入提现金额（或点击 MAX 填入全部余额）
   - 实时查看所需能量消耗（金额 × 10）
   - 点击提交按钮
5. 提交时再次检查能量：
   - 检查能量水位线（≥30）
   - 检查能量是否足够支付本次提现（金额 × 10）
6. 调用后端 API `applyWithdraw`
7. 更新本地状态
8. 触发能量刷新事件

**关键逻辑**：
- **提现按钮**：始终可点击（黄色激活状态），允许用户查看能量信息
- **能量水位线**：最低 30 能量才能提现
- **能量消耗**：1 USDT = 10 能量
- **能量信息卡片**：在提现 Modal 中始终显示，包含当前能量、能量阈值、所需能量
- **VIP 等级**：根据 RAT 余额自动计算
- **日利率**：根据等级显示（2%、4%、6%、10%）
- **历史按钮**：点击后导航到个人中心页面的"活动记录"部分

---

### 3. 个人中心 (ProfileView)

**功能**：用户信息、团队数据、活动历史

**主要组件**：
- **身份信息卡片**
  - 钱包地址显示（支持长地址，自动换行和截断）
  - BNB 资产（格式化为 5 位小数，例如：0.00109 BNB）
  - 能量值（可点击查看说明）
- **网络统计卡片**
  - 网络规模（邀请人数）
  - 总收益（团队奖励）
- **活动记录列表**
  - 空投领取记录
  - 邀请记录
  - 提现记录
  - 按时间倒序显示

**交互流程**：

**数据加载**：
1. 进入页面时自动加载
2. 调用 `fetchUserInfo` 获取能量、邀请数
3. 调用 `fetchTeamRewards` 获取团队奖励
4. **并行获取历史记录**：
   - `getClaimsHistory` - 空投领取历史
   - `getReferralHistory` - 邀请历史
   - `getWithdrawHistory` - 提现历史
5. **合并并格式化历史记录**：
   - 空投记录：显示 RAT 数量、能量奖励（+1）
   - 邀请记录：显示被邀请人地址、能量奖励（+5）
   - 提现记录：显示 USDT 数量、能量消耗（-金额×10）
6. 按时间戳倒序排序（最新的在前）
7. 只显示最近 10 条记录
8. 监听 `refreshEnergy` 事件，自动刷新数据

**能量说明 Modal**：
- 点击能量值卡片打开
- 显示能量获取方式
- 显示能量消耗规则
- VIP 特权说明

**关键逻辑**：
- 补偿刷新：检查 `rabbit_needs_userinfo_refresh_at` 标记
- 事件监听：监听 `refreshEnergy` 事件自动刷新
- 历史记录：合并三种类型，统一显示

---

### 4. 通知中心 (NotificationsView)

**功能**：站内信通知管理

**主要组件**：
- **通知列表**
  - 未读提示（红色圆点）
  - 通知类型图标
  - 通知标题和内容
  - 时间显示
- **通知详情 Modal**
  - 完整通知内容
  - 操作按钮（分享、详情）

**交互流程**：
1. 进入页面自动加载通知
2. 点击通知查看详情并标记为已读
3. 点击"全部已读"批量标记
4. 每 30 秒自动刷新

**关键逻辑**：
- 自动刷新：每 30 秒刷新一次
- 事件监听：监听 `refreshNotifications` 事件
- 已读标记：调用后端 API 标记已读

---

## 核心功能模块

### 1. 钱包连接模块

**位置**：`services/web3Service.ts`

**支持的钱包**：
- Binance Wallet（币安钱包）- 优先显示
- OKX Wallet - 优先显示
- Trust Wallet - 优先显示
- SafePal Wallet - 优先显示
- Uniswap Wallet - 优先显示
- MetaMask（备选）
- WalletConnect（移动端，其他钱包）

**钱包显示优先级**：
1. WalletConnect Modal 中优先显示：Binance、OKX、Trust、SafePal、Uniswap
2. 隐藏的钱包：Ledger Live、Fireblocks
3. 浏览器扩展钱包检测优先级：Binance > OKX > Trust > MetaMask

**功能**：
- `connectWallet(walletType)`: 连接指定钱包
- `disconnectWallet()`: 断开连接
- `switchNetwork()`: 切换到 BNB Smart Chain
- `getProvider()`: 获取当前 provider
- `getContract()`: 获取合约实例

**交互流程**：
1. 用户点击连接钱包按钮
2. 智能检测：优先检测浏览器扩展钱包（Binance > OKX > Trust > MetaMask）
3. 如果检测到扩展钱包，直接连接；否则显示 WalletConnect Modal
4. WalletConnect Modal 中优先显示：Binance、OKX、Trust、SafePal、Uniswap
5. 隐藏 Ledger Live 和 Fireblocks 钱包
6. 用户选择钱包并连接
7. 钱包弹出连接确认
8. 用户确认后获取账户地址
9. 创建 ethers provider
10. **自动检查网络**：如不匹配 BNB Smart Chain（Chain ID: 56），自动调用 `switchNetwork()`
11. 等待网络切换完成（1.5秒）
12. 重新初始化 provider 确保使用正确网络
13. 验证网络切换成功

---

### 2. 空投领取模块

**位置**：`views/MiningView.tsx`

**核心函数**：
- `handleClaim()`: 处理领取逻辑
- `fetchCooldown()`: 获取冷却时间
- `syncClaimWithRetry()`: 后端同步（带重试）
- `enqueuePendingClaim()`: 加入待同步队列

**流程**：
```
点击领取
  ↓
检查钱包连接（未连接则自动连接）
  ↓
检查冷却时间
  ↓
检查网络
  ↓
检查 BNB 余额
  ↓
估算 Gas
  ↓
发送交易
  ↓
等待确认
  ↓
解析事件
  ↓
显示奖励弹窗
  ↓
同步到后端（重试机制）
  ↓
触发能量刷新
```

**错误处理**：
- **合约交互异常代码映射**：
  - `ACTION_REJECTED` (用户点了拒绝): "您取消了交易"
  - `INSUFFICIENT_FUNDS` (没钱付 Gas): "BNB 余额不足以支付 Gas 费"
  - `CALL_EXCEPTION` (合约报错): "领取失败，可能处于冷却期或空投池已空"
  - 其他错误：解析错误信息并给出友好提示
- 网络错误：提示切换网络
- 余额不足：提示充值 BNB
- 合约空：提示联系管理员
- 冷却中：显示剩余时间
- 后端同步失败：加入本地队列，稍后自动重试

---

### 3. 提现模块

**位置**：`views/AssetView.tsx`

**核心函数**：
- `handleApplyWithdraw()`: 处理提现逻辑
- `fetchWalletRatBalance()`: 从链上获取余额
- `loadEarningsData()`: 加载收益数据

**流程**：
```
点击提现
  ↓
检查能量水位线（≥30）
  ↓
打开提现 Modal
  ↓
用户输入金额
  ↓
实时计算能量消耗
  ↓
检查能量是否足够
  ↓
调用后端 API
  ↓
更新本地状态
  ↓
触发能量刷新
```

**验证规则**：
- 能量水位线：最低 30 能量
- 能量消耗：金额 × 10
- 金额限制：不能超过可提现余额
- 输入验证：必须为正数
- **安全性**：
  - ⚠️ **重要**：前端的能量检查只是为了 UX（用户体验）
  - **后端 API 必须再次进行严格的能量扣除检查**
  - 防止黑客绕过前端直接调用 API 接口进行提现
  - 后端应该验证：能量 ≥ 30 且 能量 ≥ 提现金额 × 10

---

### 4. 推荐系统模块

**位置**：`views/MiningView.tsx`

**功能**：
- 生成推荐链接：`window.location.origin + window.location.pathname + ?ref=地址`
- 一键复制到剪贴板
- **推荐人地址持久化**：
  - 应用初始化时，如果 URL 有 `ref` 参数，立即存入 `localStorage`（键名：`rabbit_referrer`）
  - 在调用 `claim` 合约时，优先从 `localStorage` 读取
  - 如果 `localStorage` 中没有，再从 URL 参数获取
  - 这样即使用户刷新页面或路由跳转，推荐关系也不会丢失
- 在领取空投时传递给合约

**流程**：
```
用户连接钱包
  ↓
自动生成推荐链接
  ↓
用户复制链接
  ↓
分享给好友
  ↓
好友通过链接访问
  ↓
URL 中包含 ?ref=推荐人地址
  ↓
好友领取空投时，referrer 传递给合约
  ↓
推荐人获得奖励（5 能量 + 10% RAT）
```

---

### 5. 能量系统模块

**能量获取方式**：
- 每日空投领取：+1 能量
- 邀请好友成功：+5 能量

**能量消耗规则**：
- 提现收益：1 USDT = 10 能量
- 最低提现门槛：30 能量

**能量刷新机制**：
- 领取空投后触发 `refreshEnergy` 事件
- 写入本地标记 `rabbit_needs_userinfo_refresh_at`
- 进入资产页时检查标记并刷新
- 延迟重试机制（1.5 秒后再次刷新）

---

### 6. VIP 等级系统

**等级配置**：
```typescript
VIP_TIERS = [
  { level: 1, name: '🌱 新手', min: 10000, max: 49999, dailyRate: 2 },
  { level: 2, name: '🌿 进阶', min: 50000, max: 99999, dailyRate: 4 },
  { level: 3, name: '🌳 资深', min: 100000, max: 199999, dailyRate: 6 },
  { level: 4, name: '💎 核心', min: 200000, max: Infinity, dailyRate: 10 },
]
```

**计算逻辑**：
- **持币生息状态**：
  - 根据钱包 RAT 余额自动计算等级
  - 如果余额 < 10000 RAT：显示"未达到等级 (需 ≥10k RAT)"，日利率显示 0%
  - 如果余额 ≥ 10000 RAT：显示对应等级名称和日利率
- **协议进化进度条**：
  - **未达到 VIP1（余额 < 10000）**：
    - 计算距离 VIP1 的进度：`(当前余额 / 10000) × 100`
    - 最多显示 99%，达到后显示 100%
    - 示例：5000 RAT → 50%，9999 RAT → 99%
  - **已达到某个等级**：
    - 计算距离下一个等级的进度：`((当前余额 - 当前等级最小值) / (下一等级最小值 - 当前等级最小值)) × 100`
    - 示例（VIP1 → VIP2）：30000 RAT → 50%（(30000-10000)/(50000-10000)）
  - **最高等级（VIP4）边界情况**：
    - 如果用户余额 > VIP4 最大值（200000），进度条显示 "MAX" 或 "100%"
    - ⚠️ **重要**：不要尝试计算"下一级"，防止除以 0 或逻辑报错
    - 代码中应该检查 `nextTier` 是否存在，如果不存在则直接返回 100%
- **预计每日收益**：`余额 × 价格(0.01 USDT) × 日利率(%)`

---

## 交互流程

### 用户首次使用流程

```
1. 打开应用（默认显示挖矿页面）
   ↓
2. 查看公告栏（系统公告）
   ↓
3. 点击"领取RAT空投奖励"
   ↓
4. 自动弹出钱包连接界面（优先显示：币安/OKX/Trust/SafePal/Uniswap）
   ↓
5. 选择钱包并连接
   ↓
6. 自动检查并切换到 BNB Smart Chain（Chain ID: 56）
   ↓
7. 领取空投（检查冷却时间、BNB余额、Gas费用）
   ↓
8. 查看奖励弹窗（显示获得的RAT和能量）
   ↓
9. 查看资产页面（持币生息、VIP等级、收益）
   ↓
10. 查看个人中心（活动记录、团队信息）
```

### 每日使用流程

```
1. 打开应用
   ↓
2. 查看冷却时间
   ↓
3. 冷却结束后领取空投
   ↓
4. 查看资产收益
   ↓
5. 能量足够时提现收益
   ↓
6. 查看通知和公告
```

### 推荐流程

```
1. 用户 A 连接钱包
   ↓
2. 复制推荐链接
   ↓
3. 分享给用户 B
   ↓
4. 用户 B 通过链接访问
   ↓
5. 用户 B 连接钱包并领取空投
   ↓
6. 用户 A 获得推荐奖励
```

---

## API 接口

### 用户相关

#### 1. 获取用户信息
```
GET /api/user/info?address={address}
响应: { energy: number, inviteCount: number, referrer: string, usdtAvailable: number, usdtTotal: number, usdtLocked: number }
```

#### 2. 获取团队奖励
```
GET /api/user/team-rewards?address={address}
响应: { totalRewards: string }
```

#### 3. 获取空投历史
```
GET /api/user/claims?address={address}
响应: [{ txHash: string, amount: string, energy: number, createdAt: string }]
```

#### 4. 获取邀请历史
```
GET /api/user/referrals?address={address}
响应: [{ address: string, energy: number, createdAt: string }]
```

### 资产相关

#### 1. 获取 RAT 余额
```
GET /api/asset/rat-balance?address={address}
响应: { balance: string }
```

#### 2. 获取收益信息
```
GET /api/asset/earnings?address={address}
响应: { pendingUsdt: string, dailyRate: number, currentTier: number, holdingDays: number }
```

#### 3. 申请提现
```
POST /api/asset/withdraw/apply
请求体: { address: string, amount: string }
响应: { success: boolean, message: string }
```

#### 4. 获取提现历史
```
GET /api/asset/withdraw/history?address={address}
响应: [{ id: string, amount: string, status: string, time: string }]
```

### 挖矿相关

#### 1. 验证空投领取
```
POST /api/mining/verify-claim
请求体: { address: string, txHash: string, referrer: string }
响应: { success: boolean }
```

### 系统相关

#### 1. 获取系统链接
```
GET /api/system/links
响应: { whitepaper: string, audits: string, support: string }
```

#### 2. 获取系统公告
```
GET /api/system/announcement
响应: { content: string, updatedAt: string } 或 null
```

### 通知相关

#### 1. 获取用户通知
```
GET /api/user/notifications?address={address}
响应: [{ id: string, type: string, title: string, content: string, timestamp: number, read: boolean }]
```

#### 2. 标记通知已读
```
POST /api/user/notifications/read
请求体: { address: string, notificationId: string }
```

#### 3. 标记所有通知已读
```
POST /api/user/notifications/read-all
请求体: { address: string }
```

---

## 状态管理

### 全局状态（App.tsx）

```typescript
interface AppState {
  activeTab: 'mining' | 'asset' | 'profile' | 'notifications'; // 默认值：'mining'
  stats: UserStats;
  notifications: Notification[];
  announcement: string;
  systemLinks: {
    whitepaper?: string;
    audits?: string;
    support?: string;
  };
}

// 默认页面：挖矿页面
const [activeTab, setActiveTab] = useState<TabType>('mining');
```

### 用户状态（UserStats）

```typescript
interface UserStats {
  ratBalance: number;        // RAT 余额（优先从链上获取）
  bnbBalance: number;         // BNB 余额（每 10 秒从链上更新，显示 5 位小数）
  energy: number;             // 能量值
  pendingUsdt: number;        // 待提现 USDT
  teamSize: number;           // 团队规模（邀请人数）
  teamRewards: number;        // 团队奖励
  address: string;            // 钱包地址
}
```

### 本地存储

- `rabbit_pending_claims`: 待同步的空投记录
- `rabbit_needs_userinfo_refresh_at`: 需要刷新用户信息的时间戳

---

## 钱包集成

### 支持的钱包类型

```typescript
type WalletType = 'metamask' | 'okx' | 'binance' | 'trust' | 'walletconnect';
```

### 连接流程

1. **检测钱包**：检查浏览器中安装的钱包扩展
2. **请求连接**：调用 `eth_requestAccounts` 或 `enable`
3. **获取账户**：从 provider 获取当前账户地址
4. **检查网络**：验证是否为 BNB Smart Chain（Chain ID: 56）
5. **自动切换**：如不匹配，自动提示切换网络

### 网络切换

- **自动检测**：连接钱包后自动检测当前网络
- **自动切换**：如不匹配 BNB Smart Chain（Chain ID: 56），自动调用 `wallet_switchEthereumChain`
- **网络添加**：如果网络未添加，自动调用 `wallet_addEthereumChain` 添加 BNB Smart Chain
- **等待机制**：网络切换后等待 1.5 秒，确保切换完成
- **重新初始化**：切换后重新创建 provider 实例，确保使用正确的网络
- **验证机制**：切换后再次验证网络，确保切换成功
- **支持 WalletConnect**：WalletConnect 使用不同的网络切换方法

---

## 数据流

### 数据加载流程

```
应用启动（默认显示挖矿页面）
  ↓
加载系统配置（链接、公告、通知）
  ↓
用户连接钱包
  ↓
获取钱包地址
  ↓
并行加载：
  - 链上 RAT 余额（优先，失败则从 API 获取）
  - 链上 BNB 余额（每 10 秒自动更新）
  - 后端用户信息（能量、邀请数）
  - 后端收益信息
  - 通知列表
  - 历史记录（个人中心页面）
  ↓
更新全局状态
  ↓
渲染 UI
```

### 数据刷新机制

1. **定时刷新**：
   - RAT 余额和收益信息：每 30 秒自动刷新
   - BNB 余额：每 10 秒自动刷新（从链上获取）
   - 通知列表：每 30 秒自动刷新
2. **事件触发**：监听 `refreshEnergy`、`refreshNotifications` 事件
3. **补偿刷新**：检查本地标记 `rabbit_needs_userinfo_refresh_at`，进入页面时自动刷新
4. **延迟重试**：失败后延迟 1.5 秒再次尝试
5. **并行加载**：使用 `Promise.all` 并行获取多个数据源，提高加载速度

### 数据同步流程

**空投领取同步**：
```
领取成功
  ↓
获取交易哈希
  ↓
调用 verify-claim API
  ↓
失败则重试（最多 5 次，间隔 2 秒）
  ↓
仍失败则加入本地队列
  ↓
稍后自动补同步
```

---

## 错误处理

### 网络错误
- 超时：提示"请求超时，请检查网络连接"
- 连接失败：提示"网络错误，请检查后端服务是否运行"
- 自动重试机制

### 钱包错误
- 未安装钱包：提示安装对应钱包
- 用户拒绝：静默处理
- 网络不匹配：自动提示切换网络

### 交易错误
- **Gas 估算失败**：
  - 使用 `contract.estimateGas.claim()` 动态估算
  - 如果估算失败，使用合理的默认值（但不要写死 0.0001 BNB）
  - 乘以 1.2 缓冲系数防止 Out of Gas
- **余额不足**：提示充值，显示详细余额对比
- **合约错误**：解析错误信息并提示
- **合约交互异常代码映射**：
  - `ACTION_REJECTED` (4001): "您取消了交易"
  - `INSUFFICIENT_FUNDS`: "BNB 余额不足以支付 Gas 费"
  - `CALL_EXCEPTION`: "领取失败，可能处于冷却期或空投池已空"
  - `NETWORK_ERROR`: "网络错误，请检查网络连接"
  - 其他错误：解析 `error.reason` 或 `error.message` 并给出友好提示

### 后端错误
- **API 调用失败**：
  - 显示错误信息
  - **区分加载状态和默认值**：
    - 数据加载中：显示骨架屏（Skeleton）或转圈动画，或显示 "--"
    - 数据加载失败：显示错误提示，不要显示 0（会引发用户恐慌）
    - 只有明确知道用户余额确实为 0 时，才显示 0
- **数据格式错误**：
  - 使用默认值，防止崩溃
  - 记录错误日志，便于排查问题

---

## 国际化

### 支持语言
- 中文（zh）- 默认
- 英文（en）
- 日文（jp）
- 韩文（kr）
- 法文（fr）
- 俄文（ru）

### 翻译结构
```typescript
translations = {
  zh: {
    common: { ... },
    mining: { ... },
    asset: { ... },
    profile: { ... },
  },
  en: { ... },
  // ...
}
```

### 使用方式
```typescript
const { t } = useLanguage();
const text = t('common.connectWallet'); // 获取翻译文本
```

---

## 性能优化

1. **懒加载**：按需加载组件
2. **防抖节流**：输入框防抖，API 请求节流
3. **缓存机制**：本地存储缓存数据（如推荐人地址 `rabbit_referrer`）
4. **并行请求**：使用 `Promise.all` 并行加载数据
5. **事件优化**：及时清理事件监听器
6. **加载状态优化**：
   - 使用骨架屏（Skeleton）提升用户体验
   - 区分加载中、加载失败、数据为空三种状态
   - 避免在加载失败时显示 0，引发用户恐慌

---

## 安全考虑

1. **输入验证**：所有用户输入都进行验证
2. **XSS 防护**：使用 `dangerouslySetInnerHTML` 时确保内容安全
3. **钱包安全**：不存储私钥，所有操作由用户确认
4. **API 安全**：使用 HTTPS，验证响应数据
5. **错误处理**：不暴露敏感信息
6. **后端验证**：
   - ⚠️ **重要**：前端的能量检查只是为了 UX
   - 后端 API 必须再次进行严格的能量扣除检查
   - 防止黑客绕过前端直接调用 API 接口
   - 所有关键操作（提现、领取等）都必须在后端验证
7. **精度处理**：
   - 使用 BigInt 或专门的库处理大数计算
   - 避免直接用 JS number 类型（会有精度丢失）
   - 只在最后渲染 UI 时转为 number

---

## 部署说明

### 开发环境
```bash
npm install
npm run dev
```

### 生产构建
```bash
npm run build
```

### 环境变量
- 无需环境变量（API 通过 Vite 代理）

### Vite 代理配置
```typescript
proxy: {
  '/api/': {
    target: 'http://localhost:3000',
    changeOrigin: true,
  }
}
```

---

## 更新日志

### v1.1.0 (最新版本)
- ✅ 优化 WalletConnect 钱包列表显示顺序（优先显示：币安/OKX/Trust/SafePal/Uniswap）
- ✅ 移除 Ledger Live 和 Fireblocks 钱包显示
- ✅ 修复持币生息状态逻辑（根据 RAT 余额正确显示等级）
- ✅ 修复协议进化进度条逻辑（未达到 VIP1 时显示距离 VIP1 的进度）
- ✅ 优化提现按钮交互逻辑（始终可点击，能量不足时禁用内部功能）
- ✅ 添加能量信息卡片（显示当前能量、能量阈值、所需能量）
- ✅ 优化 BNB 余额显示格式（5 位小数）
- ✅ 添加 BNB 余额自动更新（每 10 秒从链上获取）
- ✅ 优化 RAT 余额获取（优先从链上获取，失败则从 API 获取）
- ✅ 优化推荐链接显示（始终显示链接，即使未连接钱包）
- ⚠️ **Gas 费用估算**：当前使用固定值 0.0001 BNB（v1.2.0 将改为动态估算）
- ✅ 添加网络自动切换功能（连接钱包后自动检查并切换网络）
- ✅ 添加断开连接提示弹窗（自定义样式）
- ✅ 优化活动记录加载（并行获取，合并显示）
- ✅ 添加历史按钮导航功能（跳转到个人中心的活动记录）
- ✅ 默认页面改为挖矿页面

### v1.2.0 (计划优化)
- 🔄 **Gas 费用动态估算**：使用 `contract.estimateGas.claim()` 动态获取，乘以 1.2 缓冲系数
- 🔄 **推荐链接持久化**：使用 `localStorage` 保存推荐人地址，防止路由跳转丢失
- 🔄 **加载状态优化**：区分 0 和 null/undefined，使用骨架屏显示加载状态
- 🔄 **精度处理优化**：使用 BigInt 处理大数计算，避免精度丢失
- 🔄 **后端安全验证**：强调后端必须再次进行能量检查
- 🔄 **错误代码映射**：完善合约交互异常代码的用户友好提示
- 🔄 **VIP 进度条边界**：处理最高等级的边界情况，防止除以 0

### v1.0.0
- ✅ 持币生息功能
- ✅ 每日空投领取
- ✅ 推荐系统
- ✅ 能量系统
- ✅ VIP 等级系统
- ✅ 提现功能
- ✅ 站内信通知
- ✅ 系统公告
- ✅ 多语言支持
- ✅ 钱包连接（MetaMask/OKX/Binance/Trust/WalletConnect）

---

## 开发注意事项

### 1. Gas 费用估算（高风险）

⚠️ **不要写死 Gas 费用值**

**问题**：写死 0.0001 BNB 在 BSC 主网上非常勉强（约 20,000 - 30,000 Gas limit）。如果合约逻辑稍微复杂一点（比如涉及写日志、计算随机数），交易很容易 Out of Gas 失败，导致用户亏钱。

**正确做法**：
```typescript
// 动态估算 Gas
const estimatedGas = await contract.estimateGas.claim(referrer);
const gasLimit = estimatedGas.mul(120).div(100); // 乘以 1.2 缓冲系数

// UI 显示：可以显示 "< 0.0005 BNB" 作为用户友好的提示
// 实际发送：使用动态估算的 Gas
const tx = await contract.claim(referrer, { gasLimit });
```

### 2. 默认值与加载状态的区别（体验问题）

⚠️ **区分 0 和 null/undefined**

**问题**：如果 API 挂了，用户看到余额是 0 或者 VIP 等级是 0，会引发恐慌。

**正确做法**：
- 数据加载中：显示骨架屏（Skeleton）或转圈动画，或显示 "--"
- 数据加载失败：显示错误提示，不要显示 0
- 只有明确知道用户余额确实为 0 时，才显示 0

```typescript
// 错误示例
const balance = data?.balance || 0; // ❌ API 失败时显示 0

// 正确示例
const balance = data?.balance ?? null; // ✅ 区分 null 和 0
if (balance === null) {
  return <Skeleton />; // 或显示 "--"
}
```

### 3. 推荐链接的持久化逻辑（逻辑漏洞）

⚠️ **使用 localStorage 保存推荐人地址**

**问题**：用户 A 点击了 B 的链接进来（URL 带 ref），然后连接了钱包。此时 URL 里的参数可能会被路由清洗掉。

**正确做法**：
```typescript
// 应用初始化时
useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get('ref');
  if (ref && ref.startsWith('0x')) {
    localStorage.setItem('rabbit_referrer', ref);
  }
}, []);

// 调用 claim 时
const referrer = localStorage.getItem('rabbit_referrer') 
  || getReferrerFromUrl() 
  || '0x0000000000000000000000000000000000000000';
```

### 4. 精度与大数处理（技术陷阱）

⚠️ **使用 BigInt 和 formatUnits 处理精度**

**问题**：前端显示时必须严格处理精度。RAT 通常是 18 位精度，链上返回的是 BigInt。

**正确做法**：
```typescript
// RAT 代币（18 位精度）
const balanceWei = await contract.balanceOf(address);
const balance = parseFloat(ethers.utils.formatUnits(balanceWei, 18));

// USDT：检查合约精度（BSC 上通常是 18 位，跨链可能是 6 位）
const decimals = await usdtContract.decimals();
const usdtBalance = parseFloat(ethers.utils.formatUnits(usdtBalanceWei, decimals));

// 计算：避免直接用 JS number 类型
// ❌ 错误：const value = balance * 0.01; // 精度丢失
// ✅ 正确：保持 BigInt 计算，只在最后渲染时转为 number
const value = parseFloat(ethers.utils.formatEther(
  balanceWei.mul(ethers.utils.parseEther('0.01')).div(ethers.utils.parseEther('1'))
));
```

### 5. 提现的后端同步（安全性）

⚠️ **后端必须再次进行能量检查**

**问题**：前端的能量检查只是为了 UX，黑客可以绕过前端直接调用 API。

**正确做法**：
- 前端：检查能量，提供良好的用户体验
- 后端：**必须再次进行严格的能量扣除检查**
  - 验证：能量 ≥ 30
  - 验证：能量 ≥ 提现金额 × 10
  - 原子性扣除能量和 USDT

### 6. 合约交互的异常代码映射

**正确做法**：
```typescript
try {
  await contract.claim(referrer);
} catch (error: any) {
  const code = error.code;
  const message = error.message || '';
  
  if (code === 'ACTION_REJECTED' || code === 4001) {
    alert('您取消了交易');
  } else if (code === 'INSUFFICIENT_FUNDS') {
    alert('BNB 余额不足以支付 Gas 费');
  } else if (code === 'CALL_EXCEPTION') {
    alert('领取失败，可能处于冷却期或空投池已空');
  } else {
    alert(error.reason || error.message || '交易失败');
  }
}
```

### 7. VIP 进度条的边界情况

⚠️ **处理最高等级的边界情况**

**问题**：如果用户余额 > VIP4（最高级），不要尝试计算"下一级"，防止除以 0。

**正确做法**：
```typescript
const progress = useMemo(() => {
  if (!currentTier) {
    // 未达到 VIP1 的逻辑
    return Math.min(Math.round((ratBalance / 10000) * 100), 99);
  }
  
  const currentIdx = VIP_TIERS.findIndex(t => t.level === currentTier.level);
  const nextTier = VIP_TIERS[currentIdx + 1];
  
  // ⚠️ 重要：检查是否有下一级
  if (!nextTier) {
    return 100; // 最高等级，显示 100%
  }
  
  // 计算到下一级的进度
  const currentMin = currentTier.min;
  const nextMin = nextTier.min;
  return Math.min(Math.round(((ratBalance - currentMin) / (nextMin - currentMin)) * 100), 100);
}, [ratBalance, currentTier]);
```

---

## 联系方式

如有问题或建议，请联系开发团队。

