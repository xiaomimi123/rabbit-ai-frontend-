# 域名迁移问题诊断工具

## 快速诊断步骤

### 1. 检查浏览器控制台

打开浏览器开发者工具（F12），切换到 Console 标签，然后：

1. **检查 API Base URL 配置**：
```javascript
// 在控制台运行
console.log('当前域名:', window.location.origin);
console.log('API Base URL:', localStorage.getItem('VITE_API_BASE_URL') || '使用环境变量');
```

2. **检查待同步队列**：
```javascript
// 检查是否有待同步的请求
const pending = localStorage.getItem('rabbit_pending_claims');
if (pending) {
  console.log('⚠️ 发现待同步的请求:', JSON.parse(pending));
} else {
  console.log('✅ 没有待同步的请求');
}
```

3. **手动测试 API 连接**：
```javascript
// 测试后端 API 是否可访问
fetch('/api/health')
  .then(r => r.json())
  .then(data => {
    console.log('✅ API 连接成功:', data);
  })
  .catch(err => {
    console.error('❌ API 连接失败:', err);
  });
```

### 2. 检查 Network 请求

1. 打开 Network 标签
2. 过滤 `/api/mining/verify-claim`
3. 尝试领取空投
4. 查看请求详情：
   - **状态码**：应该是 200
   - **请求 URL**：应该是后端地址 + `/api/mining/verify-claim`
   - **请求头**：检查 `Origin` 字段
   - **响应内容**：查看返回的数据

### 3. 检查后端日志

如果后端日志可访问，检查：
- 是否有 `/api/mining/verify-claim` 的请求记录
- 是否有错误信息
- 数据是否成功写入数据库

### 4. 检查数据库

如果可以直接访问数据库，运行以下查询：

```sql
-- 检查最近的 claim 记录
SELECT tx_hash, address, referrer, amount_wei, block_number, created_at 
FROM claims 
ORDER BY created_at DESC 
LIMIT 10;

-- 检查最近的用户记录
SELECT address, referrer_address, invite_count, energy_total, created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 10;

-- 检查是否有特定地址的记录
SELECT * FROM claims WHERE address = '0x你的地址' ORDER BY created_at DESC;
SELECT * FROM users WHERE address = '0x你的地址';
```

## 常见问题排查

### 问题 1: 请求被 CORS 阻止

**症状**：浏览器控制台显示 `CORS policy` 错误

**解决方案**：
- 虽然 CORS 配置是 `*`，但某些浏览器可能仍有问题
- 检查后端是否真的允许所有来源
- 尝试在后端明确添加新域名到 `CORS_ORIGINS`

### 问题 2: 请求超时

**症状**：Network 标签显示请求超时（Timeout）

**解决方案**：
- 检查后端服务是否正常运行
- 检查网络连接
- 增加请求超时时间

### 问题 3: 请求成功但数据未写入

**症状**：API 返回 200，但数据库没有记录

**解决方案**：
- 检查后端日志，查看是否有数据库写入错误
- 检查数据库连接是否正常
- 检查是否有事务回滚

### 问题 4: 数据写入但后台看不到

**症状**：数据库有记录，但后台管理页面看不到

**解决方案**：
- 检查后台查询逻辑
- 检查是否有时间过滤
- 检查是否有地址大小写问题（地址应该都是小写）

## 手动同步工具

如果前端同步失败，可以使用以下工具手动同步：

```javascript
// 在浏览器控制台运行
async function manualSyncClaim(address, txHash, referrer) {
  try {
    const response = await fetch('/api/mining/verify-claim', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ address, txHash, referrer }),
    });
    const data = await response.json();
    console.log('同步结果:', data);
    return data;
  } catch (error) {
    console.error('同步失败:', error);
    throw error;
  }
}

// 使用示例
// manualSyncClaim('0x你的地址', '0x交易哈希', '0x推荐人地址');
```

## 联系支持

如果以上步骤都无法解决问题，请提供：

1. **浏览器控制台完整日志**（截图或复制文本）
2. **Network 标签中的请求详情**（截图）
3. **后端日志**（如果可访问）
4. **数据库查询结果**（如果可访问）
5. **用户地址和交易哈希**

