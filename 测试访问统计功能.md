# æµ‹è¯•è®¿é—®ç»Ÿè®¡åŠŸèƒ½

## ğŸ” é—®é¢˜ç°è±¡
åç«¯æ²¡æœ‰è®¿é—® IP è®°å½•ï¼ŒNetwork é¢æ¿ä¸­æ²¡æœ‰ `POST /api/analytics/visit` è¯·æ±‚ã€‚

## ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: æ¸…é™¤ sessionStorage å¹¶æ£€æŸ¥æ§åˆ¶å°

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰æ‰§è¡Œï¼š

```javascript
// 1. æ¸…é™¤æ‰€æœ‰è®¿é—®è®°å½•æ ‡è®°
sessionStorage.removeItem('rabbit_visit_recorded');
sessionStorage.removeItem('rabbit_wallet_recorded');
sessionStorage.removeItem('rabbit_session_id');

// 2. æ£€æŸ¥ API Base URL
console.log('=== æ£€æŸ¥ API é…ç½® ===');
const apiBase = window.location.origin.includes('localhost') 
  ? 'http://localhost:5173/api/' 
  : 'https://rabbit-ai-backend.onrender.com/api/';
console.log('API Base URL:', apiBase);

// 3. æ‰‹åŠ¨å‘é€æµ‹è¯•è¯·æ±‚
console.log('=== å‘é€æµ‹è¯•è¯·æ±‚ ===');
const testData = {
  pagePath: window.location.pathname,
  walletAddress: null,
  referrer: null,
  language: 'zh',
  isMobile: /android|iphone|ipad|ipod/i.test(navigator.userAgent),
  sessionId: `test_manual_${Date.now()}`
};

const testUrl = `${apiBase}analytics/visit`;
console.log('è¯·æ±‚ URL:', testUrl);
console.log('è¯·æ±‚æ•°æ®:', testData);

fetch(testUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(testData),
})
.then(res => {
  console.log('âœ… å“åº”çŠ¶æ€:', res.status, res.statusText);
  console.log('âœ… å“åº” Headers:', Object.fromEntries(res.headers.entries()));
  return res.json();
})
.then(data => {
  console.log('âœ… å“åº”æ•°æ®:', data);
  if (data.ok) {
    console.log('ğŸ‰ è®¿é—®è®°å½•æˆåŠŸï¼');
  } else {
    console.warn('âš ï¸ è®¿é—®è®°å½•å¤±è´¥:', data.message);
  }
})
.catch(err => {
  console.error('âŒ è¯·æ±‚å¤±è´¥:', err);
  console.error('é”™è¯¯è¯¦æƒ…:', {
    message: err.message,
    stack: err.stack,
    name: err.name
  });
});
```

### æ­¥éª¤ 2: æ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦æ­£ç¡®åŠ è½½

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æ£€æŸ¥ getApiBaseUrl å‡½æ•°æ˜¯å¦å­˜åœ¨
console.log('=== æ£€æŸ¥å‰ç«¯ä»£ç  ===');

// å°è¯•åŠ¨æ€å¯¼å…¥ï¼ˆå¦‚æœå¯èƒ½ï¼‰
import('./api').then(api => {
  console.log('âœ… api æ¨¡å—åŠ è½½æˆåŠŸ');
  console.log('getApiBaseUrl å‡½æ•°:', typeof api.getApiBaseUrl);
  
  if (typeof api.getApiBaseUrl === 'function') {
    const apiBase = api.getApiBaseUrl();
    console.log('API Base URL (ä»å‡½æ•°è·å–):', apiBase);
    
    // æµ‹è¯•å‘é€è¯·æ±‚
    const testUrl = apiBase.endsWith('/') 
      ? `${apiBase}analytics/visit` 
      : `${apiBase}/analytics/visit`;
    
    console.log('æµ‹è¯• URL:', testUrl);
    
    fetch(testUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        pagePath: window.location.pathname,
        walletAddress: null,
        referrer: null,
        language: 'zh',
        isMobile: false,
        sessionId: `test_import_${Date.now()}`
      }),
    })
    .then(res => res.json())
    .then(data => {
      console.log('âœ… ä½¿ç”¨ getApiBaseUrl çš„è¯·æ±‚ç»“æœ:', data);
    })
    .catch(err => {
      console.error('âŒ è¯·æ±‚å¤±è´¥:', err);
    });
  } else {
    console.error('âŒ getApiBaseUrl ä¸æ˜¯å‡½æ•°');
  }
}).catch(err => {
  console.error('âŒ æ— æ³•åŠ è½½ api æ¨¡å—:', err);
  console.error('è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š');
  console.error('1. å‰ç«¯ä»£ç è¿˜æ²¡æœ‰é‡æ–°éƒ¨ç½²');
  console.error('2. æµè§ˆå™¨ç¼“å­˜äº†æ—§ä»£ç ');
  console.error('3. æ¨¡å—è·¯å¾„é”™è¯¯');
});
```

### æ­¥éª¤ 3: å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰

1. æŒ‰ `Ctrl + Shift + R` (Windows) æˆ– `Cmd + Shift + R` (Mac) å¼ºåˆ¶åˆ·æ–°
2. æˆ–è€…ï¼š
   - æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
   - å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
   - é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

### æ­¥éª¤ 4: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

åˆ·æ–°é¡µé¢åï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦å‡ºç°ï¼š

```
[App] Starting to record page visit...
[App] Recording page visit now...
[App] ğŸ“¤ Sending visit record: { url: ..., apiBase: ..., data: ... }
[App] ğŸ“¥ Response received: { status: 200, ... }
[App] âœ… Page visit recorded successfully
```

**å¦‚æœæ²¡æœ‰è¿™äº›æ—¥å¿—ï¼š**
- è¯´æ˜ `useEffect` æ²¡æœ‰æ‰§è¡Œ
- æˆ–è€… `sessionStorage` ä¸­å·²æœ‰æ ‡è®°
- æˆ–è€…å‰ç«¯ä»£ç è¿˜æ²¡æœ‰æ›´æ–°

### æ­¥éª¤ 5: æ£€æŸ¥ Network é¢æ¿

1. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network
2. æ¸…é™¤ä¹‹å‰çš„è¯·æ±‚
3. åˆ·æ–°é¡µé¢
4. æœç´¢ `analytics/visit`

**åº”è¯¥çœ‹åˆ°ï¼š**
- `POST /api/analytics/visit` æˆ– `POST https://rabbit-ai-backend.onrender.com/api/analytics/visit`
- çŠ¶æ€ç ï¼š200
- å“åº”ï¼š`{"ok": true, "message": "Visit recorded"}`

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: sessionStorage é˜»æ­¢é‡å¤ä¸ŠæŠ¥

**ç—‡çŠ¶ï¼š** æ§åˆ¶å°æ˜¾ç¤º `[App] Visit already recorded in this session, skipping`

**è§£å†³ï¼š**
```javascript
sessionStorage.clear();
location.reload();
```

### é—®é¢˜ 2: å‰ç«¯ä»£ç è¿˜æ²¡æœ‰æ›´æ–°

**ç—‡çŠ¶ï¼š** æ§åˆ¶å°æ²¡æœ‰ `[App] Starting to record page visit...` æ—¥å¿—

**è§£å†³ï¼š**
1. æ£€æŸ¥ Vercel/Cloudflare éƒ¨ç½²çŠ¶æ€
2. å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl + Shift + Rï¼‰
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

### é—®é¢˜ 3: CORS é”™è¯¯

**ç—‡çŠ¶ï¼š** Network é¢æ¿æ˜¾ç¤º CORS é”™è¯¯

**è§£å†³ï¼š**
1. æ£€æŸ¥åç«¯ `CORS_ORIGINS` ç¯å¢ƒå˜é‡
2. ç¡®ä¿åŒ…å«å‰ç«¯åŸŸåï¼š`https://rabbitdifi.com`

### é—®é¢˜ 4: API Base URL é”™è¯¯

**ç—‡çŠ¶ï¼š** è¯·æ±‚å‘é€åˆ°é”™è¯¯çš„åœ°å€ï¼ˆå¦‚ `https://rabbitdifi.com/api/analytics/visit`ï¼‰

**è§£å†³ï¼š**
1. æ£€æŸ¥å‰ç«¯ `VITE_API_BASE_URL` ç¯å¢ƒå˜é‡
2. åº”è¯¥è®¾ç½®ä¸ºï¼š`https://rabbit-ai-backend.onrender.com`

## ğŸ“Š è¯Šæ–­ç»“æœè®°å½•

è¯·è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

```
### æ­¥éª¤ 1: æ‰‹åŠ¨æµ‹è¯•ç»“æœ
- API Base URL: [å¡«å†™å€¼]
- è¯·æ±‚ URL: [å¡«å†™å€¼]
- è¯·æ±‚çŠ¶æ€: [200/404/500/CORSé”™è¯¯]
- å“åº”æ•°æ®: [å¡«å†™å“åº”]

### æ­¥éª¤ 2: æ¨¡å—åŠ è½½æµ‹è¯•
- api æ¨¡å—æ˜¯å¦åŠ è½½: [æ˜¯/å¦]
- getApiBaseUrl å‡½æ•°æ˜¯å¦å­˜åœ¨: [æ˜¯/å¦]
- API Base URL (ä»å‡½æ•°): [å¡«å†™å€¼]

### æ­¥éª¤ 3: æ§åˆ¶å°æ—¥å¿—
- æ˜¯å¦æœ‰ [App] Starting to record... æ—¥å¿—: [æ˜¯/å¦]
- æ˜¯å¦æœ‰ [App] ğŸ“¤ Sending visit record æ—¥å¿—: [æ˜¯/å¦]
- æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—: [æ˜¯/å¦ï¼Œå¦‚æœæœ‰è¯·å¡«å†™]

### æ­¥éª¤ 4: Network é¢æ¿
- æ˜¯å¦æœ‰ analytics/visit è¯·æ±‚: [æ˜¯/å¦]
- è¯·æ±‚ URL: [å¡«å†™å€¼]
- è¯·æ±‚çŠ¶æ€ç : [å¡«å†™å€¼]
- è¯·æ±‚å“åº”: [å¡«å†™å“åº”]
```

---

**æœ€åæ›´æ–°**: 2026-01-03

