# Rabbit AI 前端交互逻辑文档

## 目录
1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [应用架构](#应用架构)
4. [页面结构](#页面结构)
5. [核心功能模块](#核心功能模块)
6. [交互流程](#交互流程)
7. [API 接口](#api-接口)
8. [状态管理](#状态管理)
9. [钱包集成](#钱包集成)
10. [数据流](#数据流)

---

## 项目概述

Rabbit AI 是一个基于 BNB Smart Chain 的去中心化应用（DApp），采用"持币生息"模式，用户只需在钱包中持有 RAT 代币即可获得 USDT 收益。前端使用 React + TypeScript + Vite 构建，支持多语言，提供完整的 Web3 交互体验。

### 核心特性
- **持币生息**：用户持有 RAT 代币，后端自动计算 USDT 收益
- **每日空投**：用户可每日领取随机 RAT 空投奖励
- **推荐系统**：邀请好友获得能量和代币奖励
- **能量系统**：提现收益需要消耗能量值
- **VIP 等级**：根据持币量自动升级，享受不同日利率

---

## 技术栈

- **框架**：React 18 + TypeScript
- **构建工具**：Vite
- **样式**：Tailwind CSS
- **Web3**：ethers.js
- **钱包连接**：WalletConnect + MetaMask/OKX/Binance/Trust Wallet
- **HTTP 客户端**：Axios
- **国际化**：自定义 i18n 系统（支持中文、英文、日文、韩文、法文、俄文）

---

## 应用架构

### 文件结构
```
rabbit-ai-frontendxin/
├── App.tsx                 # 主应用组件，路由和全局状态
├── api.ts                  # API 接口封装
├── constants.ts            # 常量配置（合约地址、VIP 等级等）
├── types.ts                # TypeScript 类型定义
├── translations.ts        # 多语言翻译
├── index.tsx               # 应用入口
├── index.css               # 全局样式
├── contexts/
│   └── LanguageContext.tsx # 语言上下文
├── services/
│   └── web3Service.ts      # Web3 服务（钱包连接、合约交互）
├── views/
│   ├── MiningView.tsx      # 挖矿页面（空投领取）
│   ├── AssetView.tsx       # 资产页面（持币生息、提现）
│   ├── ProfileView.tsx     # 个人中心（历史记录、团队信息）
│   └── NotificationsView.tsx # 通知中心
└── components/
    └── ui/                 # UI 组件
```

### 组件层次
```
App (主应用)
├── Header (顶部导航栏)
│   ├── 语言切换菜单
│   ├── 通知按钮
│   └── 菜单按钮
├── Ticker (公告栏)
└── Main Content (主要内容区)
    ├── MiningView (挖矿页)
    ├── AssetView (资产页)
    ├── ProfileView (个人中心)
    └── NotificationsView (通知中心)
```

---

## 页面结构

### 1. 挖矿页面 (MiningView)

**功能**：每日空投领取和推荐系统

**主要组件**：
- **空投领取卡片**
  - 冷却时间倒计时显示
  - 领取按钮（自动连接钱包）
  - 区块链同步状态提示
- **推荐链接卡片**
  - 自动生成推荐链接（格式：`当前域名?ref=钱包地址`）
  - 一键复制功能
  - 推荐奖励说明
- **奖励弹窗**
  - 动画效果（缩放、滑动、光效）
  - 显示获得的 RAT 数量
  - 显示获得的能量值

**交互流程**：
1. 用户点击"领取RAT空投奖励"按钮
2. 如果未连接钱包，自动弹出钱包连接界面
3. 检查冷却时间（4小时）
4. 检查网络（BNB Smart Chain）
5. 检查 BNB 余额（支付费用和 gas）
6. 调用智能合约 `claim` 方法
7. 等待交易确认
8. 解析 `Claimed` 事件获取奖励金额
9. 显示奖励弹窗
10. 同步到后端（自动重试机制）
11. 触发能量刷新事件

**关键逻辑**：
- 冷却时间：从合约读取 `lastClaimTime`，计算剩余时间
- Referrer：从 URL 参数 `?ref=地址` 获取
- 后端同步：自动重试 5 次，失败则加入本地队列
- 能量刷新：触发 `refreshEnergy` 事件

---

### 2. 资产页面 (AssetView)

**功能**：持币生息展示、收益提现、VIP 等级

**主要组件**：
- **资产概览卡片**
  - 预估余额（RAT 余额 × 0.01 USDT）
  - 链上实时 RAT 余额
  - 持币生息状态
- **流动性收益池卡片**
  - 可提现 USDT 余额
  - 预计每日收益
  - 持币天数
  - 提现按钮（能量检查）
  - 历史记录按钮
- **VIP 等级卡片**
  - 当前等级显示
  - 等级进度条
  - 点击查看所有等级详情
- **提现 Modal**
  - 输入提现金额
  - 能量消耗计算（1 USDT = 10 能量）
  - 剩余能量显示
  - 能量水位线检查（最低 30 能量）

**交互流程**：

**资产加载**：
1. 从链上获取 RAT 余额（`balanceOf`）
2. 从后端获取收益信息（`fetchEarnings`）
3. 计算 USDT 价值（余额 × 0.01）
4. 每 30 秒自动刷新

**提现流程**：
1. 用户点击"提现"按钮
2. 检查能量水位线（≥30）
3. 弹出提现 Modal
4. 用户输入提现金额
5. 实时计算能量消耗（金额 × 10）
6. 检查能量是否足够
7. 调用后端 API `applyWithdraw`
8. 更新本地状态
9. 触发能量刷新事件

**关键逻辑**：
- 能量水位线：最低 30 能量才能提现
- 能量消耗：1 USDT = 10 能量
- VIP 等级：根据 RAT 余额自动计算
- 日利率：根据等级显示（2%、4%、6%、10%）

---

### 3. 个人中心 (ProfileView)

**功能**：用户信息、团队数据、活动历史

**主要组件**：
- **身份信息卡片**
  - 钱包地址显示
  - BNB 资产
  - 能量值（可点击查看说明）
- **网络统计卡片**
  - 网络规模（邀请人数）
  - 总收益（团队奖励）
- **活动记录列表**
  - 空投领取记录
  - 邀请记录
  - 提现记录
  - 按时间倒序显示

**交互流程**：

**数据加载**：
1. 进入页面时自动加载
2. 调用 `fetchUserInfo` 获取能量、邀请数
3. 调用 `fetchTeamRewards` 获取团队奖励
4. 调用 `getClaimsHistory`、`getReferralHistory`、`getWithdrawHistory` 获取历史
5. 合并并格式化历史记录
6. 按时间倒序排序

**能量说明 Modal**：
- 点击能量值卡片打开
- 显示能量获取方式
- 显示能量消耗规则
- VIP 特权说明

**关键逻辑**：
- 补偿刷新：检查 `rabbit_needs_userinfo_refresh_at` 标记
- 事件监听：监听 `refreshEnergy` 事件自动刷新
- 历史记录：合并三种类型，统一显示

---

### 4. 通知中心 (NotificationsView)

**功能**：站内信通知管理

**主要组件**：
- **通知列表**
  - 未读提示（红色圆点）
  - 通知类型图标
  - 通知标题和内容
  - 时间显示
- **通知详情 Modal**
  - 完整通知内容
  - 操作按钮（分享、详情）

**交互流程**：
1. 进入页面自动加载通知
2. 点击通知查看详情并标记为已读
3. 点击"全部已读"批量标记
4. 每 30 秒自动刷新

**关键逻辑**：
- 自动刷新：每 30 秒刷新一次
- 事件监听：监听 `refreshNotifications` 事件
- 已读标记：调用后端 API 标记已读

---

## 核心功能模块

### 1. 钱包连接模块

**位置**：`services/web3Service.ts`

**支持的钱包**：
- MetaMask
- OKX Wallet
- Binance Wallet
- Trust Wallet
- WalletConnect（移动端）

**功能**：
- `connectWallet(walletType)`: 连接指定钱包
- `disconnectWallet()`: 断开连接
- `switchNetwork()`: 切换到 BNB Smart Chain
- `getProvider()`: 获取当前 provider
- `getContract()`: 获取合约实例

**交互流程**：
1. 用户选择钱包类型
2. 调用 `connectWallet`
3. 钱包弹出连接确认
4. 用户确认后获取账户地址
5. 创建 ethers provider
6. 检查网络，如不匹配则自动切换

---

### 2. 空投领取模块

**位置**：`views/MiningView.tsx`

**核心函数**：
- `handleClaim()`: 处理领取逻辑
- `fetchCooldown()`: 获取冷却时间
- `syncClaimWithRetry()`: 后端同步（带重试）
- `enqueuePendingClaim()`: 加入待同步队列

**流程**：
```
点击领取
  ↓
检查钱包连接（未连接则自动连接）
  ↓
检查冷却时间
  ↓
检查网络
  ↓
检查 BNB 余额
  ↓
估算 Gas
  ↓
发送交易
  ↓
等待确认
  ↓
解析事件
  ↓
显示奖励弹窗
  ↓
同步到后端（重试机制）
  ↓
触发能量刷新
```

**错误处理**：
- 网络错误：提示切换网络
- 余额不足：提示充值 BNB
- 合约空：提示联系管理员
- 冷却中：显示剩余时间
- 后端同步失败：加入本地队列，稍后自动重试

---

### 3. 提现模块

**位置**：`views/AssetView.tsx`

**核心函数**：
- `handleApplyWithdraw()`: 处理提现逻辑
- `fetchWalletRatBalance()`: 从链上获取余额
- `loadEarningsData()`: 加载收益数据

**流程**：
```
点击提现
  ↓
检查能量水位线（≥30）
  ↓
打开提现 Modal
  ↓
用户输入金额
  ↓
实时计算能量消耗
  ↓
检查能量是否足够
  ↓
调用后端 API
  ↓
更新本地状态
  ↓
触发能量刷新
```

**验证规则**：
- 能量水位线：最低 30 能量
- 能量消耗：金额 × 10
- 金额限制：不能超过可提现余额
- 输入验证：必须为正数

---

### 4. 推荐系统模块

**位置**：`views/MiningView.tsx`

**功能**：
- 生成推荐链接：`window.location.origin + window.location.pathname + ?ref=地址`
- 一键复制到剪贴板
- 从 URL 获取 referrer 地址
- 在领取空投时传递给合约

**流程**：
```
用户连接钱包
  ↓
自动生成推荐链接
  ↓
用户复制链接
  ↓
分享给好友
  ↓
好友通过链接访问
  ↓
URL 中包含 ?ref=推荐人地址
  ↓
好友领取空投时，referrer 传递给合约
  ↓
推荐人获得奖励（5 能量 + 10% RAT）
```

---

### 5. 能量系统模块

**能量获取方式**：
- 每日空投领取：+1 能量
- 邀请好友成功：+5 能量

**能量消耗规则**：
- 提现收益：1 USDT = 10 能量
- 最低提现门槛：30 能量

**能量刷新机制**：
- 领取空投后触发 `refreshEnergy` 事件
- 写入本地标记 `rabbit_needs_userinfo_refresh_at`
- 进入资产页时检查标记并刷新
- 延迟重试机制（1.5 秒后再次刷新）

---

### 6. VIP 等级系统

**等级配置**：
```typescript
VIP_TIERS = [
  { level: 1, name: '🌱 新手', min: 10000, max: 49999, dailyRate: 2 },
  { level: 2, name: '🌿 进阶', min: 50000, max: 99999, dailyRate: 4 },
  { level: 3, name: '🌳 资深', min: 100000, max: 199999, dailyRate: 6 },
  { level: 4, name: '💎 核心', min: 200000, max: Infinity, dailyRate: 10 },
]
```

**计算逻辑**：
- 根据钱包 RAT 余额自动计算等级
- 显示当前等级和进度
- 计算预计每日收益：`余额 × 价格 × 日利率`

---

## 交互流程

### 用户首次使用流程

```
1. 打开应用
   ↓
2. 查看公告栏（系统公告）
   ↓
3. 点击"领取RAT空投奖励"
   ↓
4. 自动弹出钱包连接界面
   ↓
5. 选择钱包并连接
   ↓
6. 确认网络（BNB Smart Chain）
   ↓
7. 领取空投
   ↓
8. 查看奖励弹窗
   ↓
9. 查看资产页面（持币生息）
   ↓
10. 查看个人中心（历史记录）
```

### 每日使用流程

```
1. 打开应用
   ↓
2. 查看冷却时间
   ↓
3. 冷却结束后领取空投
   ↓
4. 查看资产收益
   ↓
5. 能量足够时提现收益
   ↓
6. 查看通知和公告
```

### 推荐流程

```
1. 用户 A 连接钱包
   ↓
2. 复制推荐链接
   ↓
3. 分享给用户 B
   ↓
4. 用户 B 通过链接访问
   ↓
5. 用户 B 连接钱包并领取空投
   ↓
6. 用户 A 获得推荐奖励
```

---

## API 接口

### 用户相关

#### 1. 获取用户信息
```
GET /api/user/info?address={address}
响应: { energy: number, inviteCount: number, referrer: string, usdtAvailable: number, usdtTotal: number, usdtLocked: number }
```

#### 2. 获取团队奖励
```
GET /api/user/team-rewards?address={address}
响应: { totalRewards: string }
```

#### 3. 获取空投历史
```
GET /api/user/claims?address={address}
响应: [{ txHash: string, amount: string, energy: number, createdAt: string }]
```

#### 4. 获取邀请历史
```
GET /api/user/referrals?address={address}
响应: [{ address: string, energy: number, createdAt: string }]
```

### 资产相关

#### 1. 获取 RAT 余额
```
GET /api/asset/rat-balance?address={address}
响应: { balance: string }
```

#### 2. 获取收益信息
```
GET /api/asset/earnings?address={address}
响应: { pendingUsdt: string, dailyRate: number, currentTier: number, holdingDays: number }
```

#### 3. 申请提现
```
POST /api/asset/withdraw/apply
请求体: { address: string, amount: string }
响应: { success: boolean, message: string }
```

#### 4. 获取提现历史
```
GET /api/asset/withdraw/history?address={address}
响应: [{ id: string, amount: string, status: string, time: string }]
```

### 挖矿相关

#### 1. 验证空投领取
```
POST /api/mining/verify-claim
请求体: { address: string, txHash: string, referrer: string }
响应: { success: boolean }
```

### 系统相关

#### 1. 获取系统链接
```
GET /api/system/links
响应: { whitepaper: string, audits: string, support: string }
```

#### 2. 获取系统公告
```
GET /api/system/announcement
响应: { content: string, updatedAt: string } 或 null
```

### 通知相关

#### 1. 获取用户通知
```
GET /api/user/notifications?address={address}
响应: [{ id: string, type: string, title: string, content: string, timestamp: number, read: boolean }]
```

#### 2. 标记通知已读
```
POST /api/user/notifications/read
请求体: { address: string, notificationId: string }
```

#### 3. 标记所有通知已读
```
POST /api/user/notifications/read-all
请求体: { address: string }
```

---

## 状态管理

### 全局状态（App.tsx）

```typescript
interface AppState {
  activeTab: 'mining' | 'asset' | 'profile' | 'notifications';
  stats: UserStats;
  notifications: Notification[];
  announcement: string;
  systemLinks: {
    whitepaper?: string;
    audits?: string;
    support?: string;
  };
}
```

### 用户状态（UserStats）

```typescript
interface UserStats {
  ratBalance: number;        // RAT 余额
  bnbBalance: number;         // BNB 余额
  energy: number;             // 能量值
  pendingUsdt: number;        // 待提现 USDT
  teamSize: number;           // 团队规模（邀请人数）
  teamRewards: number;        // 团队奖励
  address: string;            // 钱包地址
}
```

### 本地存储

- `rabbit_pending_claims`: 待同步的空投记录
- `rabbit_needs_userinfo_refresh_at`: 需要刷新用户信息的时间戳

---

## 钱包集成

### 支持的钱包类型

```typescript
type WalletType = 'metamask' | 'okx' | 'binance' | 'trust' | 'walletconnect';
```

### 连接流程

1. **检测钱包**：检查浏览器中安装的钱包扩展
2. **请求连接**：调用 `eth_requestAccounts` 或 `enable`
3. **获取账户**：从 provider 获取当前账户地址
4. **检查网络**：验证是否为 BNB Smart Chain（Chain ID: 56）
5. **自动切换**：如不匹配，自动提示切换网络

### 网络切换

- 自动检测当前网络
- 如不匹配，调用 `wallet_switchEthereumChain` 或 `wallet_addEthereumChain`
- 支持 WalletConnect 的网络切换

---

## 数据流

### 数据加载流程

```
应用启动
  ↓
加载系统配置（链接、公告）
  ↓
用户连接钱包
  ↓
获取钱包地址
  ↓
并行加载：
  - 链上 RAT 余额
  - 后端用户信息（能量、邀请数）
  - 后端收益信息
  - 通知列表
  - 历史记录
  ↓
更新全局状态
  ↓
渲染 UI
```

### 数据刷新机制

1. **定时刷新**：每 30 秒自动刷新一次
2. **事件触发**：监听 `refreshEnergy`、`refreshNotifications` 事件
3. **补偿刷新**：检查本地标记，进入页面时自动刷新
4. **延迟重试**：失败后延迟 1.5 秒再次尝试

### 数据同步流程

**空投领取同步**：
```
领取成功
  ↓
获取交易哈希
  ↓
调用 verify-claim API
  ↓
失败则重试（最多 5 次，间隔 2 秒）
  ↓
仍失败则加入本地队列
  ↓
稍后自动补同步
```

---

## 错误处理

### 网络错误
- 超时：提示"请求超时，请检查网络连接"
- 连接失败：提示"网络错误，请检查后端服务是否运行"
- 自动重试机制

### 钱包错误
- 未安装钱包：提示安装对应钱包
- 用户拒绝：静默处理
- 网络不匹配：自动提示切换网络

### 交易错误
- Gas 估算失败：使用默认值
- 余额不足：提示充值
- 合约错误：解析错误信息并提示

### 后端错误
- API 调用失败：显示错误信息
- 数据格式错误：使用默认值，防止崩溃

---

## 国际化

### 支持语言
- 中文（zh）- 默认
- 英文（en）
- 日文（jp）
- 韩文（kr）
- 法文（fr）
- 俄文（ru）

### 翻译结构
```typescript
translations = {
  zh: {
    common: { ... },
    mining: { ... },
    asset: { ... },
    profile: { ... },
  },
  en: { ... },
  // ...
}
```

### 使用方式
```typescript
const { t } = useLanguage();
const text = t('common.connectWallet'); // 获取翻译文本
```

---

## 性能优化

1. **懒加载**：按需加载组件
2. **防抖节流**：输入框防抖，API 请求节流
3. **缓存机制**：本地存储缓存数据
4. **并行请求**：使用 `Promise.all` 并行加载数据
5. **事件优化**：及时清理事件监听器

---

## 安全考虑

1. **输入验证**：所有用户输入都进行验证
2. **XSS 防护**：使用 `dangerouslySetInnerHTML` 时确保内容安全
3. **钱包安全**：不存储私钥，所有操作由用户确认
4. **API 安全**：使用 HTTPS，验证响应数据
5. **错误处理**：不暴露敏感信息

---

## 部署说明

### 开发环境
```bash
npm install
npm run dev
```

### 生产构建
```bash
npm run build
```

### 环境变量
- 无需环境变量（API 通过 Vite 代理）

### Vite 代理配置
```typescript
proxy: {
  '/api/': {
    target: 'http://localhost:3000',
    changeOrigin: true,
  }
}
```

---

## 更新日志

### v1.0.0 (当前版本)
- ✅ 持币生息功能
- ✅ 每日空投领取
- ✅ 推荐系统
- ✅ 能量系统
- ✅ VIP 等级系统
- ✅ 提现功能
- ✅ 站内信通知
- ✅ 系统公告
- ✅ 多语言支持
- ✅ 钱包连接（MetaMask/OKX/Binance/Trust/WalletConnect）

---

## 联系方式

如有问题或建议，请联系开发团队。

